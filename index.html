<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Î™©Ìöå Ïã¨Î∞© Í∏∞Î°ù ÎπÑÏÑú</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0"
  }
}
</script>
    <style>
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }
        input:focus, textarea:focus, select:focus { 
            outline: none; 
            border-color: #2563eb; 
            box-shadow: 0 0 0 2px #dbeafe;
        }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';

        // Í∞ÑÎã®Ìïú ÏïÑÏù¥ÏΩò Ïª¥Ìè¨ÎÑåÌä∏ - Ïù¥Î™®ÏßÄÎ°ú ÎåÄÏ≤¥
        const Icon = ({ name, className = "", ...props }) => {
            const iconMap = {
                BookHeart: "üìò", Cloud: "‚òÅÔ∏è", CloudOff: "üå´Ô∏è", ShieldAlert: "üõ°Ô∏è",
                Eye: "üëÅÔ∏è", EyeOff: "üö´", RotateCcw: "‚Ü©Ô∏è", Loader2: "‚è≥",
                Send: "üì§", RefreshCw: "üîÑ", HelpCircle: "‚ùì", CheckCircle2: "‚úÖ",
                Star: "‚≠ê"
            };
            
            return React.createElement('span', { 
                className: `inline-block ${className}`, 
                ...props 
            }, iconMap[name] || "‚ùì");
        };

        // --- Utility: Save to GAS ---
        const saveVisitLog = async (data) => {
            return new Promise((resolve, reject) => {
                if (window.google && window.google.script) {
                    window.google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .processForm(data);
                } else {
                    console.warn('GAS not detected. Saving to LocalStorage.');
                    try {
                        const logs = JSON.parse(localStorage.getItem('visit_logs') || '[]');
                        const newLog = {...data, id: Date.now(), timestamp: new Date().toISOString()};
                        localStorage.setItem('visit_logs', JSON.stringify([newLog, ...logs]));
                        setTimeout(() => resolve(newLog), 800);
                    } catch (error) {
                        console.error('LocalStorage Ï†ÄÏû• Ïò§Î•ò:', error);
                        reject(error);
                    }
                }
            });
        };

        const getVisitLogs = async () => {
            return new Promise((resolve, reject) => {
                if (window.google && window.google.script) {
                    window.google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getVisitLogs();
                } else {
                    try {
                        const logsJson = localStorage.getItem('visit_logs');
                        const logs = logsJson ? JSON.parse(logsJson) : [];
                        setTimeout(() => resolve(logs), 500);
                    } catch (error) {
                        console.error('LocalStorage Îç∞Ïù¥ÌÑ∞ ÏùΩÍ∏∞ Ïò§Î•ò:', error);
                        setTimeout(() => resolve([]), 500);
                    }
                }
            });
        };

        // --- Components ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('write');
            const [status, setStatus] = useState('IDLE');
            const [isConnected, setIsConnected] = useState(false);
            const [showPrivate, setShowPrivate] = useState(false);
            const [logs, setLogs] = useState([]);
            
            const [formData, setFormData] = useState({
                visiteeName: '', 
                visitDate: '', 
                visitTime: '', 
                visitType: 'Íµ¨Ïó≠Ïã¨Î∞©',
                content: '', 
                privateNote: '', 
                faithLevel: 3, 
                interests: []
            });

            useEffect(() => {
                console.log("App initialized successfully");
                
                if (window.google && window.google.script) {
                    setIsConnected(true);
                }
                
                const now = new Date();
                setFormData(prev => ({ 
                    ...prev, 
                    visitDate: now.toISOString().split('T')[0], 
                    visitTime: now.toTimeString().slice(0, 5) 
                }));
            }, []);

            const handleToggleInterest = (tag) => {
                setFormData(prev => ({
                    ...prev,
                    interests: prev.interests.includes(tag) 
                        ? prev.interests.filter(t => t !== tag) 
                        : [...prev.interests, tag]
                }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.visiteeName.trim()) {
                    alert("ÏÑ±ÎèÑ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                    return;
                }
                
                setStatus('LOADING');
                try {
                    await saveVisitLog(formData);
                    setStatus('SUCCESS');
                    setFormData(prev => ({
                        ...prev, 
                        visiteeName: '', 
                        content: '', 
                        privateNote: '', 
                        interests: []
                    }));
                } catch (err) {
                    setStatus('ERROR');
                    alert("Ï†ÄÏû• Ïã§Ìå®: " + err);
                }
            };

            const refreshHistory = async () => {
                setStatus('LOADING_HISTORY');
                try {
                    const data = await getVisitLogs();
                    setLogs(Array.isArray(data) ? data : []);
                } catch (error) {
                    console.error('Í∏∞Î°ù Î∂àÎü¨Ïò§Í∏∞ Ïò§Î•ò:', error);
                    setLogs([]);
                } finally {
                    setStatus('IDLE');
                }
            };

            useEffect(() => {
                if (activeTab === 'history') {
                    refreshHistory();
                }
            }, [activeTab]);

            const resetForm = () => {
                if (window.confirm('Î™®Îì† ÏûÖÎ†• ÎÇ¥Ïö©ÏùÑ ÏßÄÏö∏ÍπåÏöî?')) {
                    const now = new Date();
                    setFormData({
                        visiteeName: '', 
                        visitDate: now.toISOString().split('T')[0], 
                        visitTime: now.toTimeString().slice(0, 5),
                        visitType: 'Íµ¨Ïó≠Ïã¨Î∞©',
                        content: '', 
                        privateNote: '', 
                        faithLevel: 3, 
                        interests: []
                    });
                }
            };

            // React Fragment Ïò§Î•òÎ•º ÌîºÌïòÍ∏∞ ÏúÑÌï¥ divÎ°ú Í∞êÏã∏Í∏∞
            const createButtonContent = () => {
                if (status === 'LOADING') {
                    return React.createElement('div', { className: "flex items-center justify-center gap-2" },
                        React.createElement(Icon, { name: "Loader2", className: "w-6 h-6 animate-spin" })
                    );
                } else {
                    return React.createElement('div', { className: "flex items-center justify-center gap-2" },
                        React.createElement(Icon, { name: "Send", className: "w-5 h-5" }),
                        "ÏãúÌä∏Ïóê Í∏∞Î°ù Ï†ÄÏû•"
                    );
                }
            };

            return React.createElement('div', { className: "min-h-screen bg-gray-50 flex flex-col pb-32" },
                // Header
                React.createElement('header', { className: "bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50 h-16" },
                    React.createElement('div', { className: "max-w-md mx-auto px-4 h-full flex items-center justify-between" },
                        React.createElement('div', { className: "flex items-center gap-2 text-blue-700" },
                            React.createElement(Icon, { name: "BookHeart", className: "w-6 h-6" }),
                            React.createElement('h1', { className: "text-lg font-bold" }, "Î™©Ìöå Ïã¨Î∞© Í∏∞Î°ù ÎπÑÏÑú")
                        ),
                        React.createElement('div', { className: `flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold border ${isConnected ? 'bg-green-50 text-green-600 border-green-200' : 'bg-gray-50 text-gray-400'}` },
                            isConnected ? React.createElement(Icon, { name: "Cloud", className: "w-3 h-3" }) : React.createElement(Icon, { name: "CloudOff", className: "w-3 h-3" }),
                            isConnected ? "Ïó∞Í≤∞Îê®" : "Î°úÏª¨"
                        )
                    )
                ),

                React.createElement('main', { className: "max-w-md mx-auto w-full px-4 mt-6 flex-1" },
                    // Tab Navigation
                    React.createElement('div', { className: "bg-white p-1 rounded-xl shadow-sm border border-gray-200 flex mb-6 sticky top-20 z-40" },
                        ['write', 'history', 'guide'].map(tab => 
                            React.createElement('button', {
                                key: tab,
                                onClick: () => setActiveTab(tab),
                                className: `flex-1 py-2.5 rounded-lg text-sm font-bold transition-all ${activeTab === tab ? 'bg-blue-600 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`
                            }, 
                            tab === 'write' ? 'Í∏∞Î°ù' : tab === 'history' ? 'ÎÇ¥Ïó≠' : 'ÏïàÎÇ¥')
                        )
                    ),

                    activeTab === 'write' ? 
                    React.createElement('form', { onSubmit: handleSubmit, className: "space-y-6 animate-fade-in" },
                        // Section 1: Basic
                        React.createElement('div', { className: "bg-white p-5 rounded-2xl shadow-sm border border-gray-100" },
                            React.createElement('div', { className: "flex items-center gap-2 mb-4 text-blue-600 border-b border-gray-50 pb-2" },
                                React.createElement('div', { className: "flex items-center gap-2" },
                                    React.createElement('span', { className: "text-lg" }, "üë§"),
                                    React.createElement('h3', { className: "font-bold" }, "1. Í∏∞Î≥∏ Ï†ïÎ≥¥")
                                )
                            ),
                            React.createElement('div', { className: "space-y-4" },
                                React.createElement('input', {
                                    className: "w-full rounded-lg border-gray-300 border p-3 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-100",
                                    placeholder: "ÏÑ±ÎèÑ Ïù¥Î¶Ñ *",
                                    value: formData.visiteeName,
                                    onChange: e => setFormData({...formData, visiteeName: e.target.value}),
                                    required: true
                                }),
                                React.createElement('div', { className: "grid grid-cols-2 gap-3" },
                                    React.createElement('input', { 
                                        type: "date", 
                                        className: "w-full rounded-lg border-gray-300 border p-3 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-100", 
                                        value: formData.visitDate, 
                                        onChange: e => setFormData({...formData, visitDate: e.target.value}) 
                                    }),
                                    React.createElement('input', { 
                                        type: "time", 
                                        className: "w-full rounded-lg border-gray-300 border p-3 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-100", 
                                        value: formData.visitTime, 
                                        onChange: e => setFormData({...formData, visitTime: e.target.value}) 
                                    })
                                )
                            )
                        ),

                        // Section 2: Content
                        React.createElement('div', { className: "bg-white p-5 rounded-2xl shadow-sm border border-gray-100" },
                            React.createElement('div', { className: "flex items-center justify-between mb-4 border-b border-gray-50 pb-2" },
                                React.createElement('div', { className: "flex items-center gap-2 text-blue-600" },
                                    React.createElement('span', { className: "text-lg" }, "üìñ"),
                                    React.createElement('h3', { className: "font-bold" }, "2. Ïã¨Î∞© ÎÇ¥Ïö©")
                                )
                            ),
                            React.createElement('textarea', {
                                className: "w-full rounded-lg border-gray-300 border p-3 text-sm min-h-[150px] focus:border-blue-500 focus:ring-2 focus:ring-blue-100",
                                placeholder: "ÎÇòÎàà ÎßêÏîÄÍ≥º Í∏∞ÎèÑÏ†úÎ™©ÏùÑ Í∏∞Î°ùÌïòÏÑ∏Ïöî.",
                                value: formData.content,
                                onChange: e => setFormData({...formData, content: e.target.value})
                            })
                        ),

                        // Section 3: Faith Level
                        React.createElement('div', { className: "bg-white p-5 rounded-2xl shadow-sm border border-gray-100" },
                            React.createElement('div', { className: "flex items-center gap-2 mb-4 text-blue-600 border-b border-gray-50 pb-2" },
                                React.createElement('span', { className: "text-lg" }, "‚≠ê"),
                                React.createElement('h3', { className: "font-bold" }, "3. ÏòÅÏ†Å ÏÉÅÌÉú")
                            ),
                            React.createElement('div', { className: "flex gap-2 justify-center mb-4" },
                                [1, 2, 3, 4, 5].map(v => 
                                    React.createElement('button', {
                                        key: v, type: "button",
                                        onClick: () => setFormData({...formData, faithLevel: v}),
                                        className: `w-10 h-10 rounded-lg flex items-center justify-center transition-all ${formData.faithLevel >= v ? 'bg-yellow-100 text-yellow-600' : 'bg-gray-50 text-gray-300'}`
                                    }, React.createElement(Icon, { name: "Star", className: `w-6 h-6 ${formData.faithLevel >= v ? 'text-yellow-500' : 'text-gray-300'}` }))
                                )
                            ),
                            React.createElement('div', { className: "flex flex-wrap gap-2" },
                                ['Í±¥Í∞ï', 'ÏûêÎÖÄ', 'Ïû¨Ï†ï', 'Í¥ÄÍ≥Ñ', 'ÌóåÏã†'].map(tag => 
                                    React.createElement('button', {
                                        key: tag, type: "button",
                                        onClick: () => handleToggleInterest(tag),
                                        className: `px-3 py-1.5 rounded-full text-xs font-bold border transition-all ${formData.interests.includes(tag) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500 border-gray-200'}`
                                    }, `#${tag}`)
                                )
                            )
                        ),

                        // Section 4: Sensitive Note
                        React.createElement('div', { className: "bg-white p-5 rounded-2xl shadow-sm border border-red-50" },
                            React.createElement('div', { className: "flex items-center justify-between mb-4 border-b border-red-50 pb-2 text-red-600" },
                                React.createElement('div', { className: "flex items-center gap-2" },
                                    React.createElement(Icon, { name: "ShieldAlert", className: "w-5 h-5" }),
                                    React.createElement('h3', { className: "font-bold" }, "4. ÎØºÍ∞ê Ï†ïÎ≥¥")
                                ),
                                React.createElement('button', { 
                                    type: "button", 
                                    onClick: () => setShowPrivate(!showPrivate),
                                    className: "p-1 hover:bg-red-50 rounded-md"
                                },
                                    showPrivate ? React.createElement(Icon, { name: "EyeOff", className: "w-5 h-5" }) : React.createElement(Icon, { name: "Eye", className: "w-5 h-5" })
                                )
                            ),
                            showPrivate ? 
                                React.createElement('textarea', {
                                    className: "w-full p-3 text-sm border border-red-200 rounded-lg bg-red-50/20 focus:border-red-500 focus:ring-2 focus:ring-red-100",
                                    placeholder: "Î≥¥ÏïàÏù¥ ÌïÑÏöîÌïú Î©îÎ™®Î•º ÏûëÏÑ±ÌïòÏÑ∏Ïöî.",
                                    value: formData.privateNote,
                                    onChange: e => setFormData({...formData, privateNote: e.target.value})
                                }) :
                                React.createElement('div', { className: "py-4 text-center text-gray-400 text-xs" }, "Ïû†Í∏à ÏïÑÏù¥ÏΩòÏùÑ ÎàåÎü¨ Î©îÎ™®Î•º ÏûëÏÑ±ÌïòÏÑ∏Ïöî.")
                        ),

                        // Bottom Actions
                        React.createElement('div', { className: "fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-md border-t border-gray-200 z-50 safe-bottom shadow-lg" },
                            React.createElement('div', { className: "max-w-md mx-auto flex gap-3" },
                                React.createElement('button', {
                                    type: "button",
                                    onClick: resetForm,
                                    className: "p-4 bg-gray-100 rounded-2xl text-gray-500 active:scale-95 hover:bg-gray-200 transition-colors"
                                }, React.createElement(Icon, { name: "RotateCcw", className: "w-6 h-6" })),
                                React.createElement('button', {
                                    type: "submit",
                                    disabled: status === 'LOADING',
                                    className: "flex-1 bg-blue-600 text-white rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-[0.98] hover:bg-blue-700 disabled:bg-blue-400 transition-colors"
                                }, createButtonContent())
                            )
                        )
                    ) : 
                    activeTab === 'history' ? 
                    React.createElement('div', { className: "space-y-4 animate-fade-in pb-20" },
                        React.createElement('div', { className: "flex justify-between items-center mb-2" },
                            React.createElement('h2', { className: "font-bold text-gray-700" }, "ÏµúÍ∑º Ïã¨Î∞© Í∏∞Î°ù"),
                            React.createElement('button', { 
                                onClick: refreshHistory, 
                                className: `p-2 text-blue-600 hover:bg-blue-50 rounded-lg ${status === 'LOADING_HISTORY' ? 'animate-spin' : ''}` 
                            }, React.createElement(Icon, { name: "RefreshCw", className: "w-5 h-5" }))
                        ),
                        logs.length === 0 ? 
                            React.createElement('div', { className: "py-20 text-center text-gray-400" }, 
                                status === 'LOADING_HISTORY' ? "Î∂àÎü¨Ïò§Îäî Ï§ë..." : "Ï†ÄÏû•Îêú Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§."
                            ) :
                            logs.map((log, i) => React.createElement('div', { 
                                key: log.id || i, 
                                className: "bg-white p-4 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow" 
                            },
                                React.createElement('div', { className: "flex justify-between items-start mb-2" },
                                    React.createElement('div', { className: "font-bold text-blue-700" }, log.visiteeName),
                                    React.createElement('div', { className: "text-[10px] text-gray-400" }, log.visitDate)
                                ),
                                log.content ? 
                                    React.createElement('div', { className: "text-sm text-gray-600 line-clamp-2" }, log.content) :
                                    React.createElement('div', { className: "text-sm text-gray-400 italic" }, "ÎÇ¥Ïö© ÏóÜÏùå")
                            ))
                    ) :
                    React.createElement('div', { className: "bg-white p-6 rounded-2xl border border-gray-200 animate-fade-in" },
                        React.createElement('h3', { className: "font-bold text-blue-600 mb-4 flex items-center gap-2" }, 
                            React.createElement(Icon, { name: "HelpCircle", className: "w-5 h-5" }), "ÏÇ¨Ïö© Í∞ÄÏù¥Îìú"),
                        React.createElement('div', { className: "space-y-4 text-sm text-gray-600" },
                            React.createElement('p', null, "1. ÏÑ±ÎèÑ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÍ≥† Ïã¨Î∞© ÎÇ¥Ïö©ÏùÑ ÏûëÏÑ±ÌïòÏÑ∏Ïöî."),
                            React.createElement('p', null, "2. [ÏãúÌä∏ Ï†ÄÏû•]ÏùÑ ÎàÑÎ•¥Î©¥ Íµ¨Í∏Ä Ïä§ÌîÑÎ†àÎìúÏãúÌä∏Ïóê ÏûêÎèô Í∏∞Î°ùÎê©ÎãàÎã§."),
                            React.createElement('p', null, "3. ÎØºÍ∞êÌïú Ï†ïÎ≥¥Îäî 4Î≤à Ìï≠Î™©Ïùò Îàà ÏïÑÏù¥ÏΩòÏùÑ ÎàåÎü¨ ÏïàÏ†ÑÌïòÍ≤å Í∏∞Î°ùÌïòÏÑ∏Ïöî."),
                            React.createElement('div', { className: "p-4 bg-blue-50 rounded-xl text-blue-700 text-xs" }, 
                                "Tip: Íµ¨Í∏Ä Ïï±Ïä§ÌÅ¨Î¶ΩÌä∏ÏôÄ Ïó∞Í≤∞ÌïòÎ©¥ Îç∞Ïù¥ÌÑ∞Í∞Ä ÌÅ¥ÎùºÏö∞ÎìúÏóê ÏïàÏ†ÑÌïòÍ≤å Ï†ÄÏû•Îê©ÎãàÎã§.")
                        )
                    )
                ),

                // Success Modal
                status === 'SUCCESS' && React.createElement('div', { 
                    className: "fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/40 backdrop-blur-sm animate-fade-in" 
                },
                    React.createElement('div', { className: "bg-white rounded-3xl p-8 w-full max-w-xs text-center shadow-2xl" },
                        React.createElement(Icon, { name: "CheckCircle2", className: "w-16 h-16 text-green-500 mx-auto mb-4" }),
                        React.createElement('h2', { className: "text-xl font-bold mb-2" }, "Ï†ÄÏû• ÏôÑÎ£å!"),
                        React.createElement('p', { className: "text-gray-500 text-sm mb-6" }, "Í∏∞Î°ùÏù¥ ÏïàÏ†ÑÌïòÍ≤å Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§."),
                        React.createElement('button', {
                            onClick: () => setStatus('IDLE'),
                            className: "w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 transition-colors"
                        }, "ÌôïÏù∏")
                    )
                )
            );
        };

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(React.createElement(App));
    </script>
</body>
</html>
